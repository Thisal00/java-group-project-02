<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EV Master - Owner Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

    <style>

    <!-- Dashboard -->
    <div id="dashboard-view" class="view-content" style="display:block;">
        <div class="dashboard-grid">
            <div class="stat-card"><div class="value" id="total-bookings">0</div><div class="label">Total Bookings</div></div>
            <div class="stat-card"><div class="value" id="total-reviews">0</div><div class="label">Total Reviews</div></div>
            <div class="stat-card"><div class="value" id="total-expenses">Rs. 0.00</div><div class="label">Total Expenses</div></div>
            <div class="stat-card"><div class="value" id="total-cars">0</div><div class="label">Total Cars Added</div></div>
        </div>

        <div class="stat-card" style="margin-top:12px;">
            <h3>Upcoming & Active Bookings</h3>
            <div id="active-bookings-list">Loading...</div>
        </div>

        <div class="stat-card" style="margin-top:12px;">
            <h3>Finished Bookings to Review</h3>
            <div id="pending-reviews-list">Loading...</div>
        </div>
    </div>

    <!-- Map -->
    <div id="map-view" class="view-content" style="display:none;">
        <h2>Map & Stations</h2>

        <div class="filter-bar">
            <button class="btn-primary" style="width:100%;" onclick="openMapViewer()">
                <i class="fas fa-map-marker-alt"></i> Click to Open Station Map
            </button>
        </div>

        <div class="map-wrapper">
            <p id="map-help-text" style="text-align:center; padding:10px; margin:0;">
                Click <b>Open Station Map</b> → select station → it will show here.
            </p>

            <div id="station-details-view" style="display:none;">
                <h3 id="selected-station-name"></h3>
                <p id="selected-station-address" style="opacity:.8;"></p>

                <div id="station-charger-list" class="charger-card-list"></div>

                <h4 class="section-header">Book Charger</h4>
                <div id="booking-controls-area"></div>
            </div>
        </div>
    </div>

    
    
    // Navigation

    const viewContents = document.querySelectorAll('.view-content');
    const navItems = document.querySelectorAll('.nav-item');
    const viewTitle = document.getElementById('view-title');

    function showView(viewId){
        viewContents.forEach(v => v.style.display = 'none');
        navItems.forEach(n => n.classList.remove('active'));

        const view = document.getElementById(viewId + '-view');
        if(view) view.style.display = 'block';

        const nav = document.querySelector(`[onclick="showView('${viewId}')"]`);
        if(nav){
            nav.classList.add('active');
            const txt = nav.querySelector('.nav-text');
            viewTitle.textContent = txt ? txt.textContent : viewId.toUpperCase();
        }else{
            viewTitle.textContent = viewId.toUpperCase();
        }

        if(viewId === 'map'){
            document.getElementById('station-details-view').style.display = 'none';
            document.getElementById('map-help-text').style.display = 'block';
            fetchVehicles(true);
        }
        if(viewId === 'vehicles') fetchVehicles(false);
        if(viewId === 'dashboard' || viewId === 'bookings' || viewId === 'reviews') loadBookingAndReviewData();
        if(viewId === 'profile') loadProfileData();
    }

    // Startup

    document.addEventListener('DOMContentLoaded', async () => {
        showView('dashboard');
        try{
            await loadProfileData();
            await loadBookingAndReviewData();
            await fetchVehicles(true);
        }catch(e){
            if(String(e.message) === 'SESSION_EXPIRED'){
                window.location.href = '/index.html?error=session_expired';
            }
        }
    });

    ;

  
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EV Master - Owner Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>



    <!-- Profile -->
    <div id="profile-view" class="view-content" style="display:none;">
        <h2>My Profile</h2>
        <div class="form-container">
            <form id="profile-form">
                <label>Email (Read only)</label>
                <input type="email" id="profile-email" disabled />

                <label>Full Name</label>
                <input type="text" id="profile-fullname" required />

                <label>NIC</label>
                <input type="text" id="profile-nic" required />

                <label>Phone</label>
                <input type="tel" id="profile-phone" required />

                <label>User Type</label>
                <input type="text" id="profile-type" disabled />

                <button class="btn-primary" type="submit"><i class="fa-solid fa-user-pen"></i> Save Changes</button>
            </form>
        </div>
    </div>
</div>

<script>
   
    

   
    // Profile
    
    async function loadProfileData(){
        try{
            const res = await apiFetch('/api/owner/profile');
            const u = await readResBody(res);
            if(u && typeof u === 'object'){
                document.getElementById('profile-email').value = u.email || '';
                document.getElementById('profile-fullname').value = u.fullName || '';
                document.getElementById('profile-nic').value = u.nic || '';
                document.getElementById('profile-phone').value = u.phoneNumber || '';
                document.getElementById('profile-type').value = u.userType || 'EV_OWNER';

                const name = u.fullName ? u.fullName : (u.email || 'EV Owner');
                document.getElementById('welcome-message').textContent = `Welcome, ${name}!`;
            }
        }catch(e){
            if(String(e.message) === 'SESSION_EXPIRED'){
                window.location.href = '/index.html?error=session_expired';
                return;
            }
            console.error(e);
        }
    }

    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            fullName: document.getElementById('profile-fullname').value,
            nic: document.getElementById('profile-nic').value,
            phoneNumber: document.getElementById('profile-phone').value
        };
        try{
            const res = await apiFetch('/api/owner/profile', {
                method:'PUT',
                headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify(payload)
            });
            const body = await readResBody(res);
            if(res.ok){
                alert("✅ Profile updated");
                await loadProfileData();
            }else{
                alert(`❌ Update failed (${res.status}): ${typeof body === 'string' ? body : JSON.stringify(body)}`);
            }
        }catch(e2){
            if(String(e2.message) === 'SESSION_EXPIRED'){
                window.location.href = '/index.html?error=session_expired';
                return;
            }
            console.error(e2);
            alert("❌ Network error while saving profile");
        }
    });
</script>
</body>
</html>
