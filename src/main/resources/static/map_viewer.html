<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>EV Master - Charging Station Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { margin: 0; font-family: Inter, sans-serif; overflow: hidden; height: 100vh; }
        #map { height: calc(100vh - 50px); width: 100%; }

        .box {
            padding: 10px 15px;
            background: #4A90E2;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        h3 { margin: 0; font-size: 1.2em; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { font-size: 0.9em; }

        .btn-select {
            padding: 8px 15px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            background-color: #50E3C2;
            color: #0b2b24;
            margin-top: 10px;
            width: 100%;
        }
        .btn-select:hover { background-color: #40c0a8; }
    </style>
</head>

<body>
<div class="box">
    <h3>Station Map Viewer</h3>
</div>

<div id="map"></div>

<script>
    let map;

    //  Safe HTML escape
    function escapeHtml(str) {
        return String(str ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    // Normalize lat/lng (supports different field names)
    function getLatLng(station) {
        const lat =
            station.latitude ?? station.lat ?? station.Latitude ?? station.Lat ?? station.LAT;
        const lng =
            station.longitude ?? station.lng ?? station.lon ?? station.Longitude ?? station.Lng ?? station.LON;

        const nLat = Number(lat);
        const nLng = Number(lng);

        if (!Number.isFinite(nLat) || !Number.isFinite(nLng)) return null;
        if (nLat === 0 || nLng === 0) return null; // avoid (0,0) default
        return { lat: nLat, lng: nLng };
    }

    //  Send station selection back to opener dashboard
    function sendMessage(station) {
        try {
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage({
                    source: 'evMasterMapSelection',
                    stationId: station.id,
                    stationName: station.name
                }, window.location.origin);
            } else {
                alert("Dashboard window not found. Please open map from dashboard button.");
            }
        } catch (e) {
            console.error("postMessage failed:", e);
        }
        window.close();
    }

    //  Load stations from public API
    async function fetchStations() {
        const url = `/api/public/stations?v=${Date.now()}`; // cache-bust

        try {
            const res = await fetch(url, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });

            if (!res.ok) {
                const text = await res.text().catch(() => '');
                console.error("Stations API failed:", res.status, res.statusText, text);
                return [];
            }

            const data = await res.json();
            if (Array.isArray(data)) return data;
            if (data && Array.isArray(data.data)) return data.data;

            console.warn("Unexpected stations JSON:", data);
            return [];
        } catch (err) {
            console.error("fetchStations() network error:", err);
            return [];
        }
    }

    function initMap() {
        map = L.map('map', { zoomControl: true }).setView([7.8731, 80.7718], 7);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19
        }).addTo(map);

        //  Optional: try locate but don't crash if blocked
        map.locate({ setView: false, maxZoom: 13 });

        map.on('locationfound', (e) => {
            L.circle(e.latlng, { radius: 200 })
                .addTo(map)
                .bindPopup("Your Location");
        });

        map.on('locationerror', (e) => {
            console.warn("Location permission blocked:", e.message);
            // no alert needed; map still works
        });
    }

    function addMarker(station) {
        const pos = getLatLng(station);
        if (!pos) {
            console.warn("Skipping station with invalid coords:", station);
            return null;
        }

        const wrapper = document.createElement('div');

        const openTime = station.openTime ?? "";
        const closeTime = station.closeTime ?? "";

        wrapper.innerHTML = `
      <b>${escapeHtml(station.name)}</b><br>
      ${escapeHtml(station.address)}<br>
      ${openTime || closeTime ? `Open: ${escapeHtml(openTime)} | Close: ${escapeHtml(closeTime)}<br>` : ``}
      Status: ${escapeHtml(station.status)}<br>
    `;

        const btn = document.createElement('button');
        btn.className = 'btn-select';
        btn.type = 'button';
        btn.textContent = 'See Details';
        btn.addEventListener('click', () => sendMessage(station));

        wrapper.appendChild(btn);

        const marker = L.marker([pos.lat, pos.lng]).addTo(map).bindPopup(wrapper);
        return marker;
    }

    async function initMapViewer() {
        initMap();

        const stations = await fetchStations();
        console.log("Stations loaded:", stations);

        if (!stations.length) {
            alert("No stations found. Check /api/public/stations response (Network tab).");
            return;
        }

        const points = [];

        stations.forEach(s => {
            const pos = getLatLng(s);
            const marker = addMarker(s);
            if (pos && marker) points.push([pos.lat, pos.lng]);
        });

        if (!points.length) {
            alert("Stations loaded but NO valid latitude/longitude found. Check DB lat/lng fields.");
            return;
        }

        // Zoom to markers
        map.fitBounds(points, { padding: [40, 40] });
    }

    document.addEventListener('DOMContentLoaded', initMapViewer);
</script>
</body>
</html>
